import { GeocodingResult } from '@/types/patient';

// Limite de recursos por arquivo KML (Google Earth aceita at√© 10.000)
const MAX_FEATURES_PER_FILE = 9000;

/**
 * Gera arquivo KML compat√≠vel com Google Earth
 * @param results - Resultados da geocodifica√ß√£o
 * @param filename - Nome do arquivo KML
 * @param batchNumber - N√∫mero do lote (para arquivos divididos)
 * @param totalBatches - Total de lotes
 */
export const generateKML = (results: GeocodingResult[], batchNumber: number = 1, totalBatches: number = 1): string => {
  const successResults = results.filter(r => r.success && r.lat !== 0 && r.lon !== 0);
  const failedResults = results.filter(r => !r.success || r.lat === 0 || r.lon === 0);

  const batchInfo = totalBatches > 1 ? ` (Parte ${batchNumber} de ${totalBatches})` : '';

  const kmlHeader = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    <name>Geocodifica√ß√£o${batchInfo} - ${new Date().toLocaleDateString('pt-BR')}</name>
    <description>Resultados da geocodifica√ß√£o de ${results.length} endere√ßos${batchInfo}. Sucessos: ${successResults.length}, Falhas: ${failedResults.length}</description>
    
    <!-- Estilos -->
    <Style id="successIcon">
      <IconStyle>
        <color>ff00ff00</color>
        <scale>1.2</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/pushpin/grn-pushpin.png</href>
        </Icon>
      </IconStyle>
      <LabelStyle>
        <scale>0.9</scale>
      </LabelStyle>
    </Style>
    
    <Style id="failedIcon">
      <IconStyle>
        <color>ff0000ff</color>
        <scale>1.0</scale>
        <Icon>
          <href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href>
        </Icon>
      </IconStyle>
      <LabelStyle>
        <scale>0.8</scale>
      </LabelStyle>
    </Style>
    
    <!-- Placemarks de Sucesso -->
    <Folder>
      <name>Endere√ßos Geocodificados (${successResults.length})</name>
      <open>1</open>`;

  // Placemarks de sucesso
  const successPlacemarks = successResults.map((result, index) => {
    const name = result.originalData?.Nome || result.originalData?.rua || `Ponto ${index + 1}`;
    const description = createDescription(result, true);

    return `
      <Placemark>
        <name>${escapeXml(name)}</name>
        <description><![CDATA[${description}]]></description>
        <styleUrl>#successIcon</styleUrl>
        <Point>
          <coordinates>${result.lon},${result.lat},0</coordinates>
        </Point>
      </Placemark>`;
  }).join('');

  const middleSection = `
    </Folder>
    
    <!-- Placemarks com Falha -->
    <Folder>
      <name>Endere√ßos com Falha (${failedResults.length})</name>
      <open>0</open>`;

  // Placemarks de falha
  const failedPlacemarks = failedResults.map((result, index) => {
    const name = result.originalData?.Nome || result.display_name || `Falha ${index + 1}`;
    const description = createDescription(result, false);

    return `
      <Placemark>
        <name>${escapeXml(name)}</name>
        <description><![CDATA[${description}]]></description>
        <styleUrl>#failedIcon</styleUrl>
        <ExtendedData>
          <Data name="status">
            <value>failed</value>
          </Data>
          <Data name="matchLevel">
            <value>${result.matchLevel || 'no_match'}</value>
          </Data>
        </ExtendedData>
      </Placemark>`;
  }).join('');

  const kmlFooter = `
    </Folder>
  </Document>
</kml>`;

  return kmlHeader + successPlacemarks + middleSection + failedPlacemarks + kmlFooter;
};

/**
 * Cria descri√ß√£o HTML para o placemark
 */
function createDescription(result: GeocodingResult, isSuccess: boolean): string {
  const data = result.originalData || {};

  let html = '<div style="font-family: Arial, sans-serif; font-size: 12px;">';

  // Status
  if (isSuccess) {
    html += '<p style="color: green; font-weight: bold;">‚úÖ Geocodifica√ß√£o bem-sucedida</p>';
  } else {
    html += '<p style="color: red; font-weight: bold;">‚ùå Falha na geocodifica√ß√£o</p>';
    html += `<p><strong>Motivo:</strong> ${result.matchLevel || 'Endere√ßo n√£o encontrado'}</p>`;
    if (result.error) {
      html += `<p><strong>Erro:</strong> ${result.error}</p>`;
    }
  }

  // Coordenadas
  if (isSuccess) {
    html += `<p><strong>Coordenadas:</strong> ${result.lat.toFixed(6)}, ${result.lon.toFixed(6)}</p>`;
    html += `<p><strong>Match Level:</strong> ${result.matchLevel || 'N/A'}</p>`;
  }

  // Endere√ßo
  html += '<hr style="margin: 10px 0;">';
  html += '<p style="font-weight: bold;">Endere√ßo Original:</p>';

  if (data.Rua || data.rua) {
    html += `<p><strong>Rua:</strong> ${data.Rua || data.rua}</p>`;
  }
  if (data.N√∫mero || data.numero) {
    html += `<p><strong>N√∫mero:</strong> ${data.N√∫mero || data.numero}</p>`;
  }
  if (data.Bairro || data.bairro) {
    html += `<p><strong>Bairro:</strong> ${data.Bairro || data.bairro}</p>`;
  }
  if (data.Munic√≠pio || data.cidade) {
    html += `<p><strong>Cidade:</strong> ${data.Munic√≠pio || data.cidade}</p>`;
  }
  if (data.UF || data.uf) {
    html += `<p><strong>UF:</strong> ${data.UF || data.uf}</p>`;
  }
  if (data.CEP || data.cep) {
    html += `<p><strong>CEP:</strong> ${data.CEP || data.cep}</p>`;
  }

  // Dados adicionais
  if (data.Nome) {
    html += '<hr style="margin: 10px 0;">';
    html += `<p><strong>Nome:</strong> ${data.Nome}</p>`;
  }
  if (data.CPF) {
    html += `<p><strong>CPF:</strong> ${data.CPF}</p>`;
  }
  if (data.Comorbidade) {
    html += `<p><strong>Comorbidade:</strong> ${data.Comorbidade}</p>`;
  }
  if (data.UBS) {
    html += `<p><strong>UBS:</strong> ${data.UBS}</p>`;
  }

  // Endere√ßo completo retornado
  if (isSuccess && result.display_name) {
    html += '<hr style="margin: 10px 0;">';
    html += '<p style="font-weight: bold;">Endere√ßo Encontrado:</p>';
    html += `<p>${result.display_name}</p>`;
  }

  html += '</div>';

  return html;
}

/**
 * Escapa caracteres especiais XML
 */
function escapeXml(unsafe: string): string {
  return unsafe.replace(/[<>&'"]/g, (c) => {
    switch (c) {
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '&': return '&amp;';
      case '\'': return '&apos;';
      case '"': return '&quot;';
      default: return c;
    }
  });
}

/**
 * Faz download do arquivo KML
 */
export const downloadKML = (kmlContent: string, filename: string = 'geocoded_addresses.kml') => {
  const blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

/**
 * Cria arquivo ZIP com m√∫ltiplos KMLs (para grandes volumes de dados)
 */
export const downloadMultipleKMLsAsZip = async (results: GeocodingResult[], baseFilename?: string) => {
  const totalResults = results.length;
  const totalBatches = Math.ceil(totalResults / MAX_FEATURES_PER_FILE);
  const baseName = baseFilename ? baseFilename.replace('.kml', '') : `geocoded_${new Date().toISOString().split('T')[0]}`;

  // Criar um objeto para armazenar os arquivos
  const kmlFiles: { filename: string; content: string }[] = [];

  for (let i = 0; i < totalBatches; i++) {
    const start = i * MAX_FEATURES_PER_FILE;
    const end = Math.min(start + MAX_FEATURES_PER_FILE, totalResults);
    const batchResults = results.slice(start, end);
    const batchNumber = i + 1;

    const kmlContent = generateKML(batchResults, batchNumber, totalBatches);
    const filename = `${baseName}_parte${batchNumber}_de_${totalBatches}.kml`;

    kmlFiles.push({ filename, content: kmlContent });
  }

  // Criar um README com instru√ß√µes
  const readme = `INSTRU√á√ïES PARA IMPORTA√á√ÉO NO GOOGLE EARTH

Total de Recursos: ${totalResults}
Arquivos KML: ${totalBatches}

Como importar:
1. Extraia este arquivo ZIP
2. Importe cada arquivo .kml separadamente no Google Earth
3. Cada arquivo cont√©m at√© ${MAX_FEATURES_PER_FILE} recursos

Arquivos inclu√≠dos:
${kmlFiles.map(f => `- ${f.filename}`).join('\n')}

Data de Exporta√ß√£o: ${new Date().toLocaleString('pt-BR')}
`;

  kmlFiles.push({ filename: 'LEIA-ME.txt', content: readme });

  return kmlFiles;
};

/**
 * Gera e baixa KML em uma √∫nica chamada
 */
export const exportToKML = (results: GeocodingResult[], filename?: string) => {
  const totalResults = results.length;

  // Se os resultados cabem em um √∫nico arquivo
  if (totalResults <= MAX_FEATURES_PER_FILE) {
    const kmlContent = generateKML(results);
    const finalFilename = filename || `geocoded_${new Date().toISOString().split('T')[0]}.kml`;
    downloadKML(kmlContent, finalFilename);

    const successCount = results.filter(r => r.success).length;
    console.log(`‚úÖ KML exportado: ${successCount}/${results.length} endere√ßos geocodificados`);
    return;
  }

  // Dividir em m√∫ltiplos arquivos
  const totalBatches = Math.ceil(totalResults / MAX_FEATURES_PER_FILE);
  const baseFilename = filename ? filename.replace('.kml', '') : `geocoded_${new Date().toISOString().split('T')[0]}`;

  console.log(`üì¶ Dividindo ${totalResults} recursos em ${totalBatches} arquivos KML...`);

  // Download das instru√ß√µes primeiro
  downloadInstructions(totalBatches, totalResults, baseFilename);

  for (let i = 0; i < totalBatches; i++) {
    const start = i * MAX_FEATURES_PER_FILE;
    const end = Math.min(start + MAX_FEATURES_PER_FILE, totalResults);
    const batchResults = results.slice(start, end);
    const batchNumber = i + 1;

    const kmlContent = generateKML(batchResults, batchNumber, totalBatches);
    const batchFilename = `${baseFilename}_parte${batchNumber}_de_${totalBatches}.kml`;

    downloadKML(kmlContent, batchFilename);

    const successCount = batchResults.filter(r => r.success).length;
    console.log(`‚úÖ Parte ${batchNumber}/${totalBatches} exportada: ${successCount}/${batchResults.length} endere√ßos (${start + 1}-${end})`);
  }

  const totalSuccess = results.filter(r => r.success).length;
  console.log(`\n‚ú® Exporta√ß√£o completa! ${totalSuccess}/${totalResults} endere√ßos geocodificados em ${totalBatches} arquivos.`);
};

/**
 * Baixa arquivo de instru√ß√µes para m√∫ltiplos KMLs
 */
const downloadInstructions = (totalBatches: number, totalResults: number, baseFilename: string) => {
  const instructions = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë         INSTRU√á√ïES - IMPORTA√á√ÉO DE M√öLTIPLOS ARQUIVOS KML        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üìä INFORMA√á√ïES DA EXPORTA√á√ÉO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Total de Recursos:     ${totalResults.toLocaleString('pt-BR')}
Arquivos Gerados:      ${totalBatches}
Recursos por Arquivo:  At√© ${MAX_FEATURES_PER_FILE.toLocaleString('pt-BR')}
Data de Exporta√ß√£o:    ${new Date().toLocaleString('pt-BR')}

üìÅ ARQUIVOS INCLU√çDOS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

${Array.from({ length: totalBatches }, (_, i) =>
    `  ${i + 1}. ${baseFilename}_parte${i + 1}_de_${totalBatches}.kml`
  ).join('\n')}

üåç COMO IMPORTAR NO GOOGLE EARTH
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

GOOGLE EARTH DESKTOP:
  1. Abra o Google Earth Desktop
  2. V√° em: Arquivo ‚Üí Abrir
  3. Selecione o primeiro arquivo KML
  4. Aguarde o carregamento completo
  5. Repita para cada arquivo restante

GOOGLE EARTH WEB (earth.google.com/web):
  1. Acesse o Google Earth Web
  2. Menu (‚ò∞) ‚Üí Projetos ‚Üí Novo projeto
  3. Clique em "Importar arquivo KML"
  4. Selecione um arquivo por vez
  5. Aguarde a importa√ß√£o completar antes do pr√≥ximo

‚ö†Ô∏è IMPORTANTE
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚Ä¢ Importe cada arquivo SEPARADAMENTE
‚Ä¢ Aguarde o carregamento completo entre arquivos
‚Ä¢ Os arquivos aparecer√£o como camadas independentes
‚Ä¢ Voc√™ pode ativar/desativar cada camada no painel "Locais"

üí° DICAS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚Ä¢ Se o Google Earth travar, feche outros projetos primeiro
‚Ä¢ Para grandes volumes, use o Google Earth Desktop (mais robusto)
‚Ä¢ Organize as camadas por nome para facilitar a visualiza√ß√£o
‚Ä¢ Use a fun√ß√£o de zoom autom√°tico (duplo clique na camada)

üìñ ESTRUTURA DOS ARQUIVOS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Cada arquivo KML cont√©m duas pastas:

  üìç Endere√ßos Geocodificados (√çcones Verdes)
     - Pontos com geocodifica√ß√£o bem-sucedida
     - Coordenadas precisas
     - Informa√ß√µes completas do endere√ßo

  üìç Endere√ßos com Falha (√çcones Vermelhos)
     - Endere√ßos que n√£o foram localizados
     - Informa√ß√µes do erro
     - Dados originais preservados

üîç INFORMA√á√ïES POR PONTO
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Ao clicar em um ponto, voc√™ ver√°:
  ‚Ä¢ Nome/Identificador
  ‚Ä¢ Coordenadas geogr√°ficas
  ‚Ä¢ Endere√ßo original completo
  ‚Ä¢ Endere√ßo encontrado pelo geocodificador
  ‚Ä¢ N√≠vel de precis√£o (match level)
  ‚Ä¢ Dados adicionais (CPF, UBS, Comorbidade, etc.)

‚ùì PROBLEMAS COMUNS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Problema: "Mem√≥ria insuficiente"
Solu√ß√£o: Use o Google Earth Desktop ou importe menos arquivos

Problema: Aplica√ß√£o trava
Solu√ß√£o: Feche outros projetos e tente novamente

Problema: Pontos n√£o aparecem
Solu√ß√£o: Verifique se a camada est√° ativada e d√™ zoom out

üìö DOCUMENTA√á√ÉO COMPLETA
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Para mais detalhes, consulte o arquivo EXPORTACAO_KML.md no projeto.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üè• GeoSa√∫de UFAL | Sistema de Geocodifica√ß√£o de Endere√ßos de Sa√∫de
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
`;

  const blob = new Blob([instructions], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${baseFilename}_INSTRUCOES.txt`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  console.log('üìÑ Arquivo de instru√ß√µes baixado');
};